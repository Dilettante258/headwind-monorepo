use headwind_core::ColorMode;
use palette::{FromColor, Hsl, IntoColor, Oklch, Srgb};
// Oklch/Srgb/Hsl 均使用默认 f32 泛型
use phf::phf_map;

/// 色阶顺序：50, 100, 200, 300, 400, 500, 600, 700, 800, 900, 950
/// f32 精度（7 位有效数字）对颜色完全够用，且匹配 palette 默认泛型
type Shades = [(f32, f32, f32); 11];

/// 色阶名 → 数组索引
fn shade_index(shade: &str) -> Option<usize> {
    match shade {
        "50" => Some(0),
        "100" => Some(1),
        "200" => Some(2),
        "300" => Some(3),
        "400" => Some(4),
        "500" => Some(5),
        "600" => Some(6),
        "700" => Some(7),
        "800" => Some(8),
        "900" => Some(9),
        "950" => Some(10),
        _ => None,
    }
}

/// 颜色族 → 11 级 OKLCH (lightness, chroma, hue) 三元组
static PALETTE: phf::Map<&'static str, Shades> = phf_map! {
    "red" => [
        (0.971, 0.013, 17.38),   // 50
        (0.936, 0.032, 17.717),  // 100
        (0.885, 0.062, 18.334),  // 200
        (0.808, 0.114, 19.571),  // 300
        (0.704, 0.191, 22.216),  // 400
        (0.637, 0.237, 25.331),  // 500
        (0.577, 0.245, 27.325),  // 600
        (0.505, 0.213, 27.518),  // 700
        (0.444, 0.177, 26.899),  // 800
        (0.396, 0.141, 25.723),  // 900
        (0.258, 0.092, 26.042),  // 950
    ],
    "orange" => [
        (0.98,  0.016, 73.684),
        (0.954, 0.038, 75.164),
        (0.901, 0.076, 70.697),
        (0.837, 0.128, 66.29),
        (0.75,  0.183, 55.934),
        (0.705, 0.213, 47.604),
        (0.646, 0.222, 41.116),
        (0.553, 0.195, 38.402),
        (0.47,  0.157, 37.304),
        (0.408, 0.123, 38.172),
        (0.266, 0.079, 36.259),
    ],
    "amber" => [
        (0.987, 0.022, 95.277),
        (0.962, 0.059, 95.617),
        (0.924, 0.12,  95.746),
        (0.879, 0.169, 91.605),
        (0.828, 0.189, 84.429),
        (0.769, 0.188, 70.08),
        (0.666, 0.179, 58.318),
        (0.555, 0.163, 48.998),
        (0.473, 0.137, 46.201),
        (0.414, 0.112, 45.904),
        (0.279, 0.077, 45.635),
    ],
    "yellow" => [
        (0.987, 0.026, 102.212),
        (0.973, 0.071, 103.193),
        (0.945, 0.129, 101.54),
        (0.905, 0.182, 98.111),
        (0.852, 0.199, 91.936),
        (0.795, 0.184, 86.047),
        (0.681, 0.162, 75.834),
        (0.554, 0.135, 66.442),
        (0.476, 0.114, 61.907),
        (0.421, 0.095, 57.708),
        (0.286, 0.066, 53.813),
    ],
    "lime" => [
        (0.986, 0.031, 120.757),
        (0.967, 0.067, 122.328),
        (0.938, 0.127, 124.321),
        (0.897, 0.196, 126.665),
        (0.841, 0.238, 128.85),
        (0.768, 0.233, 130.85),
        (0.648, 0.2,   131.684),
        (0.532, 0.157, 131.589),
        (0.453, 0.124, 130.933),
        (0.405, 0.101, 131.063),
        (0.274, 0.072, 132.109),
    ],
    "green" => [
        (0.982, 0.018, 155.826),
        (0.962, 0.044, 156.743),
        (0.925, 0.084, 155.995),
        (0.871, 0.15,  154.449),
        (0.792, 0.209, 151.711),
        (0.723, 0.219, 149.579),
        (0.627, 0.194, 149.214),
        (0.527, 0.154, 150.069),
        (0.448, 0.119, 151.328),
        (0.393, 0.095, 152.535),
        (0.266, 0.065, 152.934),
    ],
    "emerald" => [
        (0.979, 0.021, 166.113),
        (0.95,  0.052, 163.051),
        (0.905, 0.093, 164.15),
        (0.845, 0.143, 164.978),
        (0.765, 0.177, 163.223),
        (0.696, 0.17,  162.48),
        (0.596, 0.145, 163.225),
        (0.508, 0.118, 165.612),
        (0.432, 0.095, 166.913),
        (0.378, 0.077, 168.94),
        (0.262, 0.051, 172.552),
    ],
    "teal" => [
        (0.984, 0.014, 180.72),
        (0.953, 0.051, 180.801),
        (0.91,  0.096, 180.426),
        (0.855, 0.138, 181.071),
        (0.777, 0.152, 181.912),
        (0.704, 0.14,  182.503),
        (0.6,   0.118, 184.704),
        (0.511, 0.096, 186.391),
        (0.437, 0.078, 188.216),
        (0.386, 0.063, 188.416),
        (0.277, 0.046, 192.524),
    ],
    "cyan" => [
        (0.984, 0.019, 200.873),
        (0.956, 0.045, 203.388),
        (0.917, 0.08,  205.041),
        (0.865, 0.127, 207.078),
        (0.789, 0.154, 211.53),
        (0.715, 0.143, 215.221),
        (0.609, 0.126, 221.723),
        (0.52,  0.105, 223.128),
        (0.45,  0.085, 224.283),
        (0.398, 0.07,  227.392),
        (0.302, 0.056, 229.695),
    ],
    "sky" => [
        (0.977, 0.013, 236.62),
        (0.951, 0.026, 236.824),
        (0.901, 0.058, 230.902),
        (0.828, 0.111, 230.318),
        (0.746, 0.16,  232.661),
        (0.685, 0.169, 237.323),
        (0.588, 0.158, 241.966),
        (0.5,   0.134, 242.749),
        (0.443, 0.11,  240.79),
        (0.391, 0.09,  240.876),
        (0.293, 0.066, 243.157),
    ],
    "blue" => [
        (0.97,  0.014, 254.604),
        (0.932, 0.032, 255.585),
        (0.882, 0.059, 254.128),
        (0.809, 0.105, 251.813),
        (0.707, 0.165, 254.624),
        (0.623, 0.214, 259.815),
        (0.546, 0.245, 262.881),
        (0.488, 0.243, 264.376),
        (0.424, 0.199, 265.638),
        (0.379, 0.146, 265.522),
        (0.282, 0.091, 267.935),
    ],
    "indigo" => [
        (0.962, 0.018, 272.314),
        (0.93,  0.034, 272.788),
        (0.87,  0.065, 274.039),
        (0.785, 0.115, 274.713),
        (0.673, 0.182, 276.935),
        (0.585, 0.233, 277.117),
        (0.511, 0.262, 276.966),
        (0.457, 0.24,  277.023),
        (0.398, 0.195, 277.366),
        (0.359, 0.144, 278.697),
        (0.257, 0.09,  281.288),
    ],
    "violet" => [
        (0.969, 0.016, 293.756),
        (0.943, 0.029, 294.588),
        (0.894, 0.057, 293.283),
        (0.811, 0.111, 293.571),
        (0.702, 0.183, 293.541),
        (0.606, 0.25,  292.717),
        (0.541, 0.281, 293.009),
        (0.491, 0.27,  292.581),
        (0.432, 0.232, 292.759),
        (0.38,  0.189, 293.745),
        (0.283, 0.141, 291.089),
    ],
    "purple" => [
        (0.977, 0.014, 308.299),
        (0.946, 0.033, 307.174),
        (0.902, 0.063, 306.703),
        (0.827, 0.119, 306.383),
        (0.714, 0.203, 305.504),
        (0.627, 0.265, 303.9),
        (0.558, 0.288, 302.321),
        (0.496, 0.265, 301.924),
        (0.438, 0.218, 303.724),
        (0.381, 0.176, 304.987),
        (0.291, 0.149, 302.717),
    ],
    "fuchsia" => [
        (0.977, 0.017, 320.058),
        (0.952, 0.037, 318.852),
        (0.903, 0.076, 319.62),
        (0.833, 0.145, 321.434),
        (0.74,  0.238, 322.16),
        (0.667, 0.295, 322.15),
        (0.591, 0.293, 322.896),
        (0.518, 0.253, 323.949),
        (0.452, 0.211, 324.591),
        (0.401, 0.17,  325.612),
        (0.293, 0.136, 325.661),
    ],
    "pink" => [
        (0.971, 0.014, 343.198),
        (0.948, 0.028, 342.258),
        (0.899, 0.061, 343.231),
        (0.823, 0.12,  346.018),
        (0.718, 0.202, 349.761),
        (0.656, 0.241, 354.308),
        (0.592, 0.249, 0.584),
        (0.525, 0.223, 3.958),
        (0.459, 0.187, 3.815),
        (0.408, 0.153, 2.432),
        (0.284, 0.109, 3.907),
    ],
    "rose" => [
        (0.969, 0.015, 12.422),
        (0.941, 0.03,  12.58),
        (0.892, 0.058, 10.001),
        (0.81,  0.117, 11.638),
        (0.712, 0.194, 13.428),
        (0.645, 0.246, 16.439),
        (0.586, 0.253, 17.585),
        (0.514, 0.222, 16.935),
        (0.455, 0.188, 13.697),
        (0.41,  0.159, 10.272),
        (0.271, 0.105, 12.094),
    ],
    "slate" => [
        (0.984, 0.003, 247.858),
        (0.968, 0.007, 247.896),
        (0.929, 0.013, 255.508),
        (0.869, 0.022, 252.894),
        (0.704, 0.04,  256.788),
        (0.554, 0.046, 257.417),
        (0.446, 0.043, 257.281),
        (0.372, 0.044, 257.287),
        (0.279, 0.041, 260.031),
        (0.208, 0.042, 265.755),
        (0.129, 0.042, 264.695),
    ],
    "gray" => [
        (0.985, 0.002, 247.839),
        (0.967, 0.003, 264.542),
        (0.928, 0.006, 264.531),
        (0.872, 0.01,  258.338),
        (0.707, 0.022, 261.325),
        (0.551, 0.027, 264.364),
        (0.446, 0.03,  256.802),
        (0.373, 0.034, 259.733),
        (0.278, 0.033, 256.848),
        (0.21,  0.034, 264.665),
        (0.13,  0.028, 261.692),
    ],
    "zinc" => [
        (0.985, 0.0,   0.0),
        (0.967, 0.001, 286.375),
        (0.92,  0.004, 286.32),
        (0.871, 0.006, 286.286),
        (0.705, 0.015, 286.067),
        (0.552, 0.016, 285.938),
        (0.442, 0.017, 285.786),
        (0.37,  0.013, 285.805),
        (0.274, 0.006, 286.033),
        (0.21,  0.006, 285.885),
        (0.141, 0.005, 285.823),
    ],
    "neutral" => [
        (0.985, 0.0, 0.0),
        (0.97,  0.0, 0.0),
        (0.922, 0.0, 0.0),
        (0.87,  0.0, 0.0),
        (0.708, 0.0, 0.0),
        (0.556, 0.0, 0.0),
        (0.439, 0.0, 0.0),
        (0.371, 0.0, 0.0),
        (0.269, 0.0, 0.0),
        (0.205, 0.0, 0.0),
        (0.145, 0.0, 0.0),
    ],
    "stone" => [
        (0.985, 0.001, 106.423),
        (0.97,  0.001, 106.424),
        (0.923, 0.003, 48.717),
        (0.869, 0.005, 56.366),
        (0.709, 0.01,  56.259),
        (0.553, 0.013, 58.071),
        (0.444, 0.011, 73.639),
        (0.374, 0.01,  67.558),
        (0.268, 0.007, 34.298),
        (0.216, 0.006, 56.043),
        (0.147, 0.004, 49.25),
    ],
};

// ---------------------------------------------------------------------------
// 颜色转换辅助函数（基于 palette crate）
// ---------------------------------------------------------------------------

/// OKLCH 三元组 → sRGB (gamut-clamp 到 0-255)
fn oklch_to_rgb(l: f32, c: f32, h: f32) -> (u8, u8, u8) {
    let oklch = Oklch::new(l, c, h);
    let rgb: Srgb = oklch.into_color();
    let r = (rgb.red.clamp(0.0, 1.0) * 255.0).round() as u8;
    let g = (rgb.green.clamp(0.0, 1.0) * 255.0).round() as u8;
    let b = (rgb.blue.clamp(0.0, 1.0) * 255.0).round() as u8;
    (r, g, b)
}

/// OKLCH 三元组 → hex 字符串
fn oklch_to_hex(l: f32, c: f32, h: f32) -> String {
    let (r, g, b) = oklch_to_rgb(l, c, h);
    format!("#{:02x}{:02x}{:02x}", r, g, b)
}

/// OKLCH 三元组 → oklch() CSS 函数
fn oklch_to_css(l: f32, c: f32, h: f32) -> String {
    format!("oklch({} {} {})", l, c, h)
}

/// OKLCH 三元组 → hsl() CSS 函数
fn oklch_to_hsl(l: f32, c: f32, h: f32) -> String {
    let oklch = Oklch::new(l, c, h);
    let rgb: Srgb = oklch.into_color();
    let rgb = Srgb::new(
        rgb.red.clamp(0.0, 1.0),
        rgb.green.clamp(0.0, 1.0),
        rgb.blue.clamp(0.0, 1.0),
    );
    let hsl: Hsl = Hsl::from_color(rgb);
    let hue = hsl.hue.into_positive_degrees();
    let sat = (hsl.saturation * 100.0).round() as i32;
    let lit = (hsl.lightness * 100.0).round() as i32;
    format!("hsl({}, {}%, {}%)", hue.round() as i32, sat, lit)
}

// ---------------------------------------------------------------------------
// 公开 API
// ---------------------------------------------------------------------------

/// 从 "red-500" 解析出 ("red", "500")
fn parse_color_name(name: &str) -> Option<(&str, &str)> {
    let idx = name.rfind('-')?;
    Some((&name[..idx], &name[idx + 1..]))
}

/// 根据颜色名和输出模式获取颜色值
///
/// 支持：
/// - 特殊值："black" / "white" / "transparent" / "current"
/// - 带色阶值："red-500" / "blue-200" / "slate-950"
pub fn get_color(name: &str, mode: ColorMode) -> Option<String> {
    // 特殊颜色
    match name {
        "black" => {
            return Some(match mode {
                ColorMode::Var => "var(--color-black)".into(),
                ColorMode::Hex => "#000000".into(),
                ColorMode::Oklch => "oklch(0 0 0)".into(),
                ColorMode::Hsl => "hsl(0, 0%, 0%)".into(),
            })
        }
        "white" => {
            return Some(match mode {
                ColorMode::Var => "var(--color-white)".into(),
                ColorMode::Hex => "#ffffff".into(),
                ColorMode::Oklch => "oklch(1 0 0)".into(),
                ColorMode::Hsl => "hsl(0, 0%, 100%)".into(),
            })
        }
        "transparent" => return Some("transparent".into()),
        "current" => return Some("currentColor".into()),
        _ => {}
    }

    let (family, shade) = parse_color_name(name)?;
    let idx = shade_index(shade)?;
    let shades = PALETTE.get(family)?;
    let (l, c, h) = shades[idx];

    Some(match mode {
        ColorMode::Var => format!("var(--color-{})", name),
        ColorMode::Hex => oklch_to_hex(l, c, h),
        ColorMode::Oklch => oklch_to_css(l, c, h),
        ColorMode::Hsl => oklch_to_hsl(l, c, h),
    })
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_special_colors() {
        assert_eq!(get_color("black", ColorMode::Hex), Some("#000000".into()));
        assert_eq!(get_color("white", ColorMode::Hex), Some("#ffffff".into()));
        assert_eq!(
            get_color("transparent", ColorMode::Hex),
            Some("transparent".into())
        );
        assert_eq!(
            get_color("current", ColorMode::Hex),
            Some("currentColor".into())
        );
    }

    #[test]
    fn test_hex_mode() {
        let hex = get_color("blue-500", ColorMode::Hex).unwrap();
        assert!(hex.starts_with('#'));
        assert_eq!(hex.len(), 7);
    }

    #[test]
    fn test_oklch_mode() {
        assert_eq!(
            get_color("blue-500", ColorMode::Oklch),
            Some("oklch(0.623 0.214 259.815)".into())
        );
    }

    #[test]
    fn test_var_mode() {
        assert_eq!(
            get_color("blue-500", ColorMode::Var),
            Some("var(--color-blue-500)".into())
        );
        assert_eq!(
            get_color("black", ColorMode::Var),
            Some("var(--color-black)".into())
        );
    }

    #[test]
    fn test_hsl_mode() {
        let hsl = get_color("blue-500", ColorMode::Hsl).unwrap();
        assert!(hsl.starts_with("hsl("));
        assert!(hsl.ends_with(')'));
    }

    #[test]
    fn test_all_color_families() {
        let families = [
            "red", "orange", "amber", "yellow", "lime", "green", "emerald", "teal", "cyan",
            "sky", "blue", "indigo", "violet", "purple", "fuchsia", "pink", "rose", "slate",
            "gray", "zinc", "neutral", "stone",
        ];
        let shades = ["50", "100", "200", "300", "400", "500", "600", "700", "800", "900", "950"];

        for family in &families {
            for shade in &shades {
                let name = format!("{}-{}", family, shade);
                assert!(
                    get_color(&name, ColorMode::Hex).is_some(),
                    "Missing: {}",
                    name
                );
            }
        }
    }

    #[test]
    fn test_unknown_color() {
        assert_eq!(get_color("unknown-500", ColorMode::Hex), None);
        assert_eq!(get_color("red-999", ColorMode::Hex), None);
    }
}
